# テンプレート構文リファレンス

## 概要

kinToysのテンプレート機能は、kintoneのレコードデータをテンプレートに埋め込むための仕組みです。
テンプレート内にプレースホルダを記述しておくことで、kintoneレコードの値を動的に挿入できます。

### 用途

- レコードデータを含むメール本文の生成
- 帳票・レポートのテキスト生成
- 定型文へのデータ差し込み

## 基本構文

### 単純なプレースホルダ

```
%フィールドコード%
```

kintoneで設定したフィールドコードを `%` で囲むことで、そのフィールドの値に置換されます。

**例:**

テンプレート:
```
お客様名: %customer_name%
メールアドレス: %email%
```

レコードデータ:
```
customer_name: "山田太郎"
email: "yamada@example.com"
```

出力結果:
```
お客様名: 山田太郎
メールアドレス: yamada@example.com
```

## 配列・サブテーブル構文

### サブテーブルのプレースホルダ

```
%サブテーブルフィールドコード{
  繰り返しテンプレート
}%
```

サブテーブル（テーブルフィールド）のデータを埋め込む場合、`%フィールドコード{` と `}%` で囲んだ範囲がサブテーブルの各行に対して繰り返し生成されます。

繰り返しテンプレート内では、サブテーブル内のフィールドコードを `%サブフィールドコード%` の形式で使用できます。

**例:**

テンプレート:
```
注文明細:
%order_details{
商品: %product_name% / 数量: %quantity% / 単価: %unit_price%
}%
```

レコードデータ（order_detailsサブテーブル）:
```
order_details: [
  { product_name: "商品A", quantity: "2", unit_price: "1000" },
  { product_name: "商品B", quantity: "1", unit_price: "2500" }
]
```

出力結果:
```
注文明細:
商品: 商品A / 数量: 2 / 単価: 1000
商品: 商品B / 数量: 1 / 単価: 2500
```

## 使用例

### 請求書メールテンプレート

```
%company_name% 御中

いつもお世話になっております。
下記の通りご請求申し上げます。

請求番号: %invoice_number%
請求日: %invoice_date%

【明細】
%items{
  %item_name%  %quantity%個  ¥%amount%
}%

合計金額: ¥%total_amount%

お支払い期限: %due_date%

よろしくお願いいたします。
```

### 顧客情報通知テンプレート

```
顧客ID: %customer_id%
氏名: %last_name% %first_name%
住所: %prefecture%%city%%address%
電話番号: %phone%
```

## kintone計算式スニペット

kinToys自体には高度な文字列処理機能はありませんが、kintoneの計算機能を使うことでほとんどのケースに対応できます。
以下に、テンプレートで使用する値を準備するための計算式の例を紹介します。

### 日付のフォーマット

日付フィールドから「○月○日」形式の文字列を作成するには、文字列フィールドで以下の計算式を設定します。

```
DATE_FORMAT(開催日, "M月d日", "Asia/Tokyo")
```

**よく使うフォーマット:**

| フォーマット | 出力例 |
|-------------|--------|
| `"YYYY年M月d日"` | 2025年4月15日 |
| `"M月d日"` | 4月15日 |
| `"YYYY/MM/dd"` | 2025/04/15 |
| `"HH:mm"` | 14:30 |

### 日付から曜日を求める

日付フィールドから曜日を取得するには、文字列フィールドで以下の計算式を設定します。

```
IF( ( ( (開催日 / 60 / 60 / 24) - 0) / 7 ) - ROUNDUP(( ( (開催日 / 60 / 60 / 24) - 0) / 7 ) , 0) = 0 , "木曜",
  IF( ( ( (開催日 / 60 / 60 / 24) - 1) / 7 ) - ROUNDUP(( ( (開催日 / 60 / 60 / 24) - 1) / 7 ) , 0) = 0 , "金曜",
    IF( ( ( (開催日 / 60 / 60 / 24) - 2) / 7 ) - ROUNDUP(( ( (開催日 / 60 / 60 / 24) - 2) / 7 ) , 0) = 0 , "土曜",
      IF( ( ( (開催日 / 60 / 60 / 24) - 3) / 7 ) - ROUNDUP(( ( (開催日 / 60 / 60 / 24) - 3) / 7 ) , 0) = 0 , "日曜",
        IF( ( ( (開催日 / 60 / 60 / 24) - 4) / 7 ) - ROUNDUP(( ( (開催日 / 60 / 60 / 24) - 4) / 7 ) , 0) = 0 , "月曜",
          IF( ( ( (開催日 / 60 / 60 / 24) - 5) / 7 ) - ROUNDUP(( ( (開催日 / 60 / 60 / 24) - 5) / 7 ) , 0) = 0 , "火曜",
            IF( ( ( (開催日 / 60 / 60 / 24) - 6) / 7 ) - ROUNDUP(( ( (開催日 / 60 / 60 / 24) - 6) / 7 ) , 0) = 0 , "水曜","該当なし"
            )
          )
        )
      )
    )
  )
)
```

### 活用例：日付と曜日を組み合わせたテンプレート

**kintoneフィールド設定:**
- `開催日`: 日付フィールド
- `開催日表示`: 文字列フィールド（計算式: `DATE_FORMAT(開催日, "M月d日", "Asia/Tokyo")`）
- `開催曜日`: 文字列フィールド（上記の曜日計算式）

**テンプレート:**
```
イベント開催のお知らせ

開催日時: %開催日表示%（%開催曜日%）
```

**出力結果:**
```
イベント開催のお知らせ

開催日時: 4月15日（火曜）
```

## 注意事項

1. **フィールドコードの正確な指定**
   - フィールドコードはkintoneのアプリ設定で確認できるものを使用してください
   - 大文字・小文字は区別されます（例: `Name` と `name` は別のフィールドとして扱われます）

2. **存在しないフィールドコード**
   - テンプレート内に存在しないフィールドコードを指定した場合、プレースホルダはそのまま残ります

3. **サブテーブル構文の制約**
   - サブテーブル構文 `%フィールドコード{ ... }%` は、フィールドの値が配列（サブテーブル）の場合にのみ機能します
   - サブテーブルではないフィールドにこの構文を使用した場合、テンプレートはそのまま残ります
